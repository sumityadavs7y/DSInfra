<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Receipt - <%= payment.receiptNo %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        @media print {
            .no-print {
                display: none !important;
            }
            body {
                margin: 0;
                padding: 0;
            }
            .print-container {
                box-shadow: none !important;
                margin: 0;
                padding: 20px;
            }
        }
        body {
            background-color: #f5f5f5;
            font-family: 'Arial', sans-serif;
        }
        .print-container {
            width: 210mm;
            min-height: 297mm;
            margin: 10mm auto;
            background: white;
            padding: 15mm;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .title {
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .header-table {
            width: 100%;
            margin-bottom: 10px;
            font-size: 9px;
            border-collapse: collapse;
        }
        .header-table td {
            border: 1px solid #000;
            padding: 5px;
        }
        .header-table .label {
            font-weight: bold;
        }
        .section-header {
            background-color: #f0f0f0;
            padding: 3px 8px;
            font-weight: bold;
            font-size: 10px;
            margin-top: 8px;
            margin-bottom: 3px;
            border: 1px solid #000;
        }
        .detail-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 9px;
            margin-bottom: 5px;
        }
        .detail-table td {
            padding: 1px 5px;
            vertical-align: top;
            line-height: 1.3;
        }
        .detail-table .label {
            font-weight: bold;
            width: 150px;
            white-space: nowrap;
        }
        .detail-table .value {
            width: auto;
        }
        .payment-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 9px;
            margin-top: 10px;
        }
        .payment-table th,
        .payment-table td {
            border: 1px solid #000;
            padding: 3px 5px;
            text-align: left;
        }
        .payment-table th {
            background-color: #f0f0f0;
            font-weight: bold;
        }
        .payment-table td {
            height: 14px;
            line-height: 1.2;
        }
        .terms {
            margin-top: 15px;
            font-size: 8px;
            line-height: 1.5;
        }
        .terms strong {
            font-weight: bold;
        }
        .print-button {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        @page {
            margin: 15mm -5mm 15mm -5mm;
            size: A4;
        }
    </style>
</head>
<body>
    <!-- Print Button -->
    <button onclick="window.print()" class="btn btn-success no-print print-button">
        <i class="bi bi-printer"></i> Print
    </button>

    <div class="print-container">
        <!-- Title -->
        <div class="title">PAYMENT RECEIPT</div>

        <!-- Header Information -->
        <table class="header-table">
            <tr>
                <td style="width: 33%;"><span class="label">Booking Appl. No.</span> :<b> <%= payment.booking.bookingNo %></b></td>
                <td style="width: 34%;"><span class="label">Receipt No:</span> <%= payment.receiptNo %></td>
                <td style="width: 33%;"><span class="label">Date:</span> <%= new Date(payment.receiptDate).toLocaleDateString('en-IN') %></td>
            </tr>
        </table>

        <!-- APPLICANTS DETAILS Section -->
        <div class="section-header">APPLICANTS DETAILS</div>
        <table class="detail-table">
            <tr>
                <td class="label">Mr./Ms./Mrs/M+Dr</td>
                <td class="value" style="width: 40%;">: <%= payment.booking.customer.applicantName %></td>
                <td class="label" style="width: 130px;">Aadhar No.</td>
                <td class="value">: <%= payment.booking.customer.aadhaarNo || 'NA' %></td>
            </tr>
            <tr>
                <td class="label">Son/Wife/Daughter of</td>
                <td class="value" style="width: 40%;">: <%= payment.booking.customer.fatherOrHusbandName || 'NA' %></td>
                <td class="label" style="width: 130px;">Mobile No.</td>
                <td class="value">: <%= payment.booking.customer.mobileNo || 'NA' %></td>
            </tr>
            <tr>
                <td class="label">Address</td>
                <td class="value" colspan="3">: <%= payment.booking.customer.address %></td>
            </tr>
        </table>

        <!-- PAYMENT DETAILS Section -->
        <div class="section-header">PAYMENT DETAILS</div>
        <table class="detail-table">
            <tr>
                <td class="label">Amt. Received (Rs.)</td>
                <td class="value" colspan="3">: <strong>₹ <%= parseFloat(payment.paymentAmount).toLocaleString('en-IN') %></strong> &nbsp;&nbsp;&nbsp; ( Rupees <%= amountInWords %> Only )</td>
            </tr>
            <tr>
                <td class="label">Payment Mode</td>
                <td class="value">: <%= payment.paymentMode %></td>
                <td colspan="2">
                    <table style="width: 100%; border-collapse: collapse;">
                        <tr>
                            <td style="width: 50%; padding: 0;"><strong>Transaction No.:</strong> <%= payment.transactionNo || 'NA' %></td>
                            <td style="width: 50%; padding: 0;"><strong>Date :</strong> <%= new Date(payment.receiptDate).toLocaleDateString('en-IN') %></td>
                        </tr>
                    </table>
                </td>
            </tr>
            <tr>
                <td class="label">Remarks (If Any)</td>
                <td class="value" colspan="3">: <%= payment.remarks || 'NA' %></td>
            </tr>
        </table>

        <!-- PREVIOUS PAYMENT DETAILS Section -->
        <div class="section-header">PREVIOUS PAYMENT DETAILS</div>
        
        <%
        // Get previous payments (excluding current one)
        const previousPayments = (typeof allPaymentsData !== 'undefined' && allPaymentsData) 
            ? allPaymentsData.filter(p => p.id !== payment.id) 
            : [];
        
        // Calculate totals
        const totalPaidAmount = (typeof totalPaid !== 'undefined') ? totalPaid : parseFloat(payment.paymentAmount);
        const totalBookingAmount = parseFloat(payment.booking.totalAmount);
        const pendingAmount = totalBookingAmount - totalPaidAmount;
        %>

        <!-- Payment History and Totals Side by Side -->
        <div style="display: flex; gap: 10px; margin-top: 10px;">
            <!-- Payment History Table (Left) -->
            <div style="flex: 0 0 65%;">
                <table class="payment-table">
                    <thead>
                        <tr>
                            <th style="width: 15%;">Date</th>
                            <th style="width: 25%;">Transaction No.</th>
                            <th style="width: 20%;">Mode</th>
                            <th style="width: 20%;">Amount</th>
                            <th style="width: 20%;">Recpt. No.</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% for (let i = 0; i < 5; i++) { %>
                        <tr>
                            <% if (i < previousPayments.length) { 
                                const p = previousPayments[i];
                            %>
                                <td><%= new Date(p.receiptDate).toLocaleDateString('en-IN') %></td>
                                <td><%= p.transactionNo || '-' %></td>
                                <td><%= p.paymentMode %></td>
                                <td>₹<%= parseFloat(p.paymentAmount).toLocaleString('en-IN') %></td>
                                <td><%= p.receiptNo %></td>
                            <% } else { %>
                                <td>&nbsp;</td>
                                <td>&nbsp;</td>
                                <td>&nbsp;</td>
                                <td>&nbsp;</td>
                                <td>&nbsp;</td>
                            <% } %>
                        </tr>
                        <% } %>
                    </tbody>
                </table>
            </div>

            <!-- Totals and Signature (Right) -->
            <div style="flex: 1; display: flex; flex-direction: column;">
                <div style="padding: 8px; font-size: 9px; font-weight: bold; text-align: right; line-height: 1.8; flex-grow: 1;">
                    <div><span class="label">TOTAL AMOUNT (Rs.) :</span> &nbsp; ₹ <%= totalBookingAmount.toLocaleString('en-IN') %></div>
                    <div><span class="label">PENDING AMOUNT (Rs.) :</span> &nbsp; ₹ <%= pendingAmount.toLocaleString('en-IN') %></div>
                </div>
                <div style="text-align: center; margin-top: 40px; font-size: 9px;">
                    ( Authorised Signatory )
                </div>
            </div>
        </div>

        <!-- Terms & Condition -->
        <div class="terms">
            <strong>Terms & Condition :</strong> Applicable bank charges shall be levied on outstation cheques. In case the cheque or payment instrument is returned unpaid for any reason, the booking will automatically stand cancelled without any further notice.
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
