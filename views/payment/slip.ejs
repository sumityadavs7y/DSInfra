<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Receipt - <%= payment.receiptNo %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        @media print {
            .no-print {
                display: none !important;
            }
            body {
                margin: 0;
                padding: 0;
            }
            .print-container {
                box-shadow: none !important;
                margin: 0;
                padding: 5mm;
            }
            .title {
                font-size: 13px !important;
                margin-bottom: 2px !important;
            }
            .header-table {
                font-size: 8px !important;
                margin-bottom: 2px !important;
            }
            .section-header {
                font-size: 9px !important;
                margin-top: 2px !important;
                margin-bottom: 1px !important;
                padding: 1px 5px !important;
            }
            .detail-table {
                font-size: 8px !important;
                margin-bottom: 2px !important;
            }
            .detail-table td {
                padding: 0.5px 3px !important;
                line-height: 1.2 !important;
            }
            .payment-table {
                font-size: 8px !important;
                margin-top: 2px !important;
            }
            .payment-table th,
            .payment-table td {
                padding: 1.5px 3px !important;
            }
            .payment-table td {
                height: 10px !important;
            }
            .terms {
                font-size: 7px !important;
                margin-top: 3px !important;
                line-height: 1.3 !important;
            }
        }
        body {
            background-color: #f5f5f5;
            font-family: 'Arial', sans-serif;
        }
        .print-container {
            width: 210mm;
            min-height: 148.5mm;
            margin: 10mm auto;
            background: white;
            padding: 8mm;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .title {
            text-align: center;
            font-size: 15px;
            font-weight: bold;
            margin-bottom: 4px;
        }
        .header-table {
            width: 100%;
            margin-bottom: 4px;
            font-size: 9px;
            border-collapse: collapse;
        }
        .header-table td {
            border: 1px solid #000;
            padding: 3px;
        }
        .header-table .label {
            font-weight: bold;
        }
        .section-header {
            background-color: #f0f0f0;
            padding: 2px 6px;
            font-weight: bold;
            font-size: 10px;
            margin-top: 4px;
            margin-bottom: 2px;
            border: 1px solid #000;
        }
        .detail-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 9px;
            margin-bottom: 2px;
        }
        .detail-table td {
            padding: 0.5px 4px;
            vertical-align: top;
            line-height: 1.2;
        }
        .detail-table .label {
            font-weight: bold;
            width: 130px;
            white-space: nowrap;
        }
        .detail-table .value {
            width: auto;
        }
        .payment-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 9px;
            margin-top: 4px;
        }
        .payment-table th,
        .payment-table td {
            border: 1px solid #000;
            padding: 2px 4px;
            text-align: left;
        }
        .payment-table th {
            background-color: #f0f0f0;
            font-weight: bold;
        }
        .payment-table td {
            height: 11px;
            line-height: 1.2;
        }
        .terms {
            margin-top: 4px;
            font-size: 8px;
            line-height: 1.3;
        }
        .terms strong {
            font-weight: bold;
        }
        .print-button {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        @page {
            margin: 15mm -5mm 10mm -5mm;
            size: A4;
        }
    </style>
</head>
<body>
    <!-- Print Button -->
    <button onclick="window.print()" class="btn btn-success no-print print-button">
        <i class="bi bi-printer"></i> Print
    </button>

    <div class="print-container">
        <!-- Title -->
        <div class="title">PAYMENT RECEIPT</div>

        <!-- Header Information -->
        <table class="header-table">
            <tr>
                <td style="width: 33%;"><span class="label">Booking Appl. No.</span> :<b> <%= payment.booking.bookingNo %></b></td>
                <td style="width: 34%;"><span class="label">Receipt No:</span> <%= payment.receiptNo %></td>
                <td style="width: 33%;"><span class="label">Date:</span> <%= new Date(payment.receiptDate).toLocaleDateString('en-IN') %></td>
            </tr>
        </table>

        <!-- APPLICANTS DETAILS Section -->
        <div class="section-header">APPLICANTS DETAILS</div>
        <table class="detail-table">
            <tr>
                <td class="label">Mr./Ms./Mrs/M+Dr</td>
                <td class="value" style="width: 40%;">: <%= payment.booking.customer.applicantName %></td>
                <td class="label" style="width: 130px;">Aadhar No.</td>
                <td class="value">: <%= payment.booking.customer.aadhaarNo || 'NA' %></td>
            </tr>
            <tr>
                <td class="label">Son/Wife/Daughter of</td>
                <td class="value" style="width: 40%;">: <%= payment.booking.customer.fatherOrHusbandName || 'NA' %></td>
                <td class="label" style="width: 130px;">Mobile No.</td>
                <td class="value">: <%= payment.booking.customer.mobileNo || 'NA' %></td>
            </tr>
            <tr>
                <td class="label">Address</td>
                <td class="value" colspan="3">: <%= payment.booking.customer.address %></td>
            </tr>
        </table>

        <!-- PAYMENT DETAILS Section -->
        <div class="section-header">PAYMENT DETAILS</div>
        <table class="detail-table">
            <tr>
                <td class="label">Amt. Received (Rs.)</td>
                <td class="value" colspan="3">: <strong>₹ <%= parseFloat(payment.paymentAmount).toLocaleString('en-IN') %></strong> &nbsp;&nbsp;&nbsp; ( Rupees <%= amountInWords %> Only )</td>
            </tr>
            <tr>
                <td class="label">Payment Mode</td>
                <td class="value">: <%= payment.paymentMode %></td>
                <td colspan="2">
                    <table style="width: 100%; border-collapse: collapse;">
                        <tr>
                            <td style="width: 50%; padding: 0;"><strong>Transaction No.:</strong> <%= payment.transactionNo || 'NA' %></td>
                            <td style="width: 50%; padding: 0;"><strong>Date :</strong> <%= new Date(payment.receiptDate).toLocaleDateString('en-IN') %></td>
                        </tr>
                    </table>
                </td>
            </tr>
            <tr>
                <td class="label">Remarks (If Any)</td>
                <td class="value" colspan="3">: <%= payment.remarks || 'NA' %></td>
            </tr>
        </table>

        <!-- PREVIOUS PAYMENT DETAILS Section -->
        <div class="section-header">PREVIOUS PAYMENT DETAILS</div>
        
        <%
        // Get previous payments (excluding current one)
        const previousPayments = (typeof allPaymentsData !== 'undefined' && allPaymentsData) 
            ? allPaymentsData.filter(p => p.id !== payment.id) 
            : [];
        
        // Calculate totals
        const totalPaidAmount = (typeof totalPaid !== 'undefined') ? totalPaid : parseFloat(payment.paymentAmount);
        const totalBookingAmount = parseFloat(payment.booking.totalAmount);
        const pendingAmount = totalBookingAmount - totalPaidAmount;
        %>

        <!-- Payment History and Totals Merged Table -->
        <table class="payment-table">
            <tr>
                <th style="width: 13%;">Date</th>
                <th style="width: 20%;">Transaction No.</th>
                <th style="width: 13%;">Mode</th>
                <th style="width: 15%;">Amount</th>
                <th style="width: 14%;">Recpt. No.</th>
                <th style="width: 25%; font-weight: bold; background-color: #f0f0f0;">SUMMARY</th>
            </tr>
            <% for (let i = 0; i < 5; i++) { %>
            <tr style="height: 18px;">
                <% if (i < previousPayments.length) { 
                    const p = previousPayments[i];
                %>
                    <td><%= new Date(p.receiptDate).toLocaleDateString('en-IN') %></td>
                    <td><%= p.transactionNo || '-' %></td>
                    <td><%= p.paymentMode %></td>
                    <td>₹<%= parseFloat(p.paymentAmount).toLocaleString('en-IN') %></td>
                    <td><%= p.receiptNo %></td>
                <% } else { %>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                <% } %>
                <% if (i === 0) { %>
                <td rowspan="5" style="vertical-align: top; padding: 4px 6px;">
                    <div style="display: flex; flex-direction: column; justify-content: space-between; height: 100%;">
                        <div style="font-size: 9px; font-weight: bold; line-height: 1.5;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 2px;">
                                <span>TOTAL:</span>
                                <span>₹ <%= totalBookingAmount.toLocaleString('en-IN') %></span>
                            </div>
                            <div style="display: flex; justify-content: space-between; border-top: 1px solid #ccc; padding-top: 2px;">
                                <span>PENDING:</span>
                                <span>₹ <%= pendingAmount.toLocaleString('en-IN') %></span>
                            </div>
                        </div>
                        <div style="text-align: center; font-size: 9px; font-weight: normal; margin-top: 15px; padding-top: 8px; border-top: 1px solid #000;">
                            ( Authorised Signatory )
                        </div>
                    </div>
                </td>
                <% } %>
            </tr>
            <% } %>
        </table>

        <!-- Terms & Condition -->
        <div class="terms">
            <strong>Terms & Condition :</strong> Applicable bank charges shall be levied on outstation cheques. In case the cheque or payment instrument is returned unpaid for any reason, the booking will automatically stand cancelled without any further notice.
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
