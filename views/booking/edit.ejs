<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Booking</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
</head>
<body class="bg-light">
    <nav class="navbar navbar-dark bg-primary shadow-sm">
        <div class="container-fluid">
            <div>
                <a href="/booking/<%= booking.id %>" class="btn btn-outline-light btn-sm me-2">
                    <i class="bi bi-arrow-left"></i> Back
                </a>
                <span class="navbar-brand mb-0 h1">Edit Booking - <%= booking.bookingNo %></span>
            </div>
        </div>
    </nav>

    <div class="container my-4">
        <div class="row justify-content-center">
            <div class="col-12 col-xl-10">
                <div class="card border-0 shadow-sm">
                    <div class="card-body p-4">
                        <% if (error) { %>
                            <div class="alert alert-danger"><i class="bi bi-exclamation-triangle"></i> <%= error %></div>
                        <% } %>
                        
                        <form method="POST" action="/booking/<%= booking.id %>/edit" id="bookingForm">
                            <!-- Customer -->
                            <h5 class="text-primary mb-3"><i class="bi bi-person"></i> Customer Information</h5>
                            <div class="mb-4">
                                <label class="form-label fw-semibold">Customer *</label>
                                <select class="form-select" name="customerId" required>
                                    <% customers.forEach(customer => { %>
                                        <option value="<%= customer.id %>" <%= booking.customerId == customer.id ? 'selected' : '' %>>
                                            <%= customer.applicantName %> - <%= customer.mobileNo %> (<%= customer.customerNo %>)
                                        </option>
                                    <% }); %>
                                </select>
                            </div>
                            
                            <hr class="my-4">
                            
                            <!-- Property -->
                            <h5 class="text-primary mb-3"><i class="bi bi-house"></i> Property Details</h5>
                            <div class="row g-3 mb-4">
                                <div class="col-12 col-md-6">
                                    <label class="form-label fw-semibold">Booking Date *</label>
                                    <input type="date" class="form-control" name="bookingDate" 
                                           value="<%= new Date(booking.bookingDate).toISOString().split('T')[0] %>" required>
                                    <div class="form-text">Can be edited if needed</div>
                                </div>
                                <div class="col-12 col-md-6">
                                    <label class="form-label fw-semibold">Project *</label>
                                    <select class="form-select" name="projectId" required>
                                        <% projects.forEach(project => { %>
                                            <option value="<%= project.id %>" <%= booking.projectId == project.id ? 'selected' : '' %>>
                                                <%= project.projectName %>
                                            </option>
                                        <% }); %>
                                    </select>
                                </div>
                                <div class="col-12 col-md-6">
                                    <label class="form-label fw-semibold">Plot Number *</label>
                                    <input type="text" class="form-control" name="plotNo" value="<%= booking.plotNo %>" required>
                                </div>
                                <div class="col-6 col-md-3">
                                    <label class="form-label fw-semibold">Area (sq.ft.) *</label>
                                    <input type="number" class="form-control" name="area" id="area" value="<%= parseFloat(booking.area) %>" step="0.01" required>
                                </div>
                                <div class="col-6 col-md-3">
                                    <label class="form-label fw-semibold">Rate (₹) *</label>
                                    <input type="number" class="form-control" name="rate" id="rate" value="<%= parseFloat(booking.rate) %>" step="0.01" required>
                                </div>
                                <div class="col-6 col-md-3">
                                    <label class="form-label fw-semibold">Associate Rate (₹)</label>
                                    <input type="number" class="form-control" name="associateRate" id="associateRate" value="<%= parseFloat(booking.associateRate || 0) %>" step="0.01">
                                    <div class="form-text">For broker commission</div>
                                </div>
                                <div class="col-6 col-md-3">
                                    <label class="form-label fw-semibold">PLC (₹)</label>
                                    <input type="number" class="form-control" name="plc" id="plc" value="<%= parseFloat(booking.plc) %>" step="0.01">
                                </div>
                                <div class="col-6 col-md-3">
                                    <label class="form-label fw-semibold">Discount (₹)</label>
                                    <input type="number" class="form-control" name="discount" id="discount" value="<%= parseFloat(booking.discount) %>" step="0.01">
                                </div>
                                <div class="col-6 col-md-6">
                                    <label class="form-label fw-semibold">Effective Rate (₹)</label>
                                    <input type="number" class="form-control bg-light" id="effectiveRate" value="<%= parseFloat(booking.effectiveRate) %>" readonly>
                                </div>
                                <div class="col-6 col-md-6">
                                    <label class="form-label fw-semibold">Total Amount (₹)</label>
                                    <input type="number" class="form-control bg-light" id="totalAmount" value="<%= parseFloat(booking.totalAmount) %>" readonly>
                                </div>
                                <div class="col-12">
                                    <label class="form-label fw-semibold">Legal Details</label>
                                    <textarea class="form-control" name="legalDetails" rows="2"><%= booking.legalDetails || '' %></textarea>
                                </div>
                            </div>
                            
                            <hr class="my-4">
                            
                            <!-- Broker Details (Optional) -->
                            <h5 class="text-dark mb-3"><i class="bi bi-briefcase"></i> Broker Details (Optional)</h5>
                            <div class="row g-3 mb-4">
                                <div class="col-12 col-md-6">
                                    <label class="form-label fw-semibold">Broker</label>
                                    <select class="form-select" name="brokerId" id="brokerSelect">
                                        <option value="">-- No Broker --</option>
                                        <% brokers.forEach(broker => { %>
                                            <option value="<%= broker.id %>" <%= booking.brokerId == broker.id ? 'selected' : '' %>>
                                                <%= broker.name %> (<%= broker.mobileNo %>)
                                            </option>
                                        <% }) %>
                                    </select>
                                    <div class="form-text">Select if this booking was referred by a broker</div>
                                </div>
                                <div class="col-12 col-md-6">
                                    <label class="form-label fw-semibold">Broker Commission (₹)</label>
                                    <input type="number" class="form-control bg-light" name="brokerCommission" id="brokerCommission" 
                                           value="<%= parseFloat(booking.brokerCommission || 0) %>" 
                                           step="0.01" min="0" readonly>
                                    <div class="form-text">Auto-calculated: (Associate Rate - Rate) × Area</div>
                                </div>
                            </div>
                            
                            <hr class="my-4">
                            
                            <!-- Status -->
                            <h5 class="text-primary mb-3"><i class="bi bi-info-circle"></i> Booking Status</h5>
                            <div class="row g-3 mb-4">
                                <div class="col-12">
                                    <label class="form-label fw-semibold">Status</label>
                                    <select class="form-select" name="status">
                                        <option value="Active" <%= booking.status === 'Active' ? 'selected' : '' %>>Active</option>
                                        <option value="Completed" <%= booking.status === 'Completed' ? 'selected' : '' %>>Completed</option>
                                        <option value="Cancelled" <%= booking.status === 'Cancelled' ? 'selected' : '' %>>Cancelled</option>
                                    </select>
                                    <div class="form-text">
                                        <i class="bi bi-info-circle"></i> To edit payment details, go to the Payments section on the booking details page.
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-flex gap-2 justify-content-end">
                                <a href="/booking/<%= booking.id %>" class="btn btn-secondary">Cancel</a>
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-check-circle"></i> Update Booking
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const area = document.getElementById('area');
        const rate = document.getElementById('rate');
        const associateRate = document.getElementById('associateRate');
        const plc = document.getElementById('plc');
        const discount = document.getElementById('discount');
        const effectiveRate = document.getElementById('effectiveRate');
        const totalAmount = document.getElementById('totalAmount');
        const brokerCommission = document.getElementById('brokerCommission');
        const brokerSelect = document.getElementById('brokerSelect');
        
        function calculateAmounts() {
            const areaVal = parseFloat(area.value) || 0;
            const rateVal = parseFloat(rate.value) || 0;
            const associateRateVal = parseFloat(associateRate.value) || 0;
            const plcVal = parseFloat(plc.value) || 0;
            const discountVal = parseFloat(discount.value) || 0;
            
            const effRate = rateVal - discountVal;
            const total = (areaVal * effRate) + plcVal;
            
            effectiveRate.value = effRate.toFixed(2);
            totalAmount.value = total.toFixed(2);
            
            // Auto-calculate broker commission: (associateRate - rate) * area
            if (brokerSelect.value && associateRateVal > 0) {
                const commission = (associateRateVal - rateVal) * areaVal;
                brokerCommission.value = commission > 0 ? commission.toFixed(2) : '0.00';
            } else {
                brokerCommission.value = '0.00';
            }
        }
        
        [area, rate, associateRate, plc, discount].forEach(el => el.addEventListener('input', calculateAmounts));
        calculateAmounts();
        
        // Recalculate when broker is selected/deselected
        brokerSelect.addEventListener('change', function() {
            calculateAmounts();
        });
    </script>
</body>
</html>
