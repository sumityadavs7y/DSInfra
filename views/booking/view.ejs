<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Booking <%= booking.bookingNo %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
</head>
<body class="bg-light">
        <%- include('../partials/page-header', { 
        title: 'Booking Details', 
        icon: 'bi-receipt', 
        backUrl: '/booking', 
        actionUrl: (userRole !== 'associate' && userRole !== 'team_leader') ? '/booking/' + booking.id + '/edit' : '', 
        actionText: (userRole !== 'associate' && userRole !== 'team_leader') ? 'Edit' : '', 
        actionIcon: 'bi-pencil'
    }) %>

    <!-- Action Buttons -->
    <div class="container my-3">
        <div class="row justify-content-center">
            <div class="col-12 col-xl-10">
                <a href="/booking/<%= booking.id %>/slip" target="_blank" class="btn btn-primary">
                    <i class="bi bi-printer"></i> Print Booking Slip
                </a>
                <a href="/booking/<%= booking.id %>/slip-letterhead" target="_blank" class="btn btn-success ms-2">
                    <i class="bi bi-printer-fill"></i> Print with Letter Head
                </a>
            </div>
        </div>
    </div>

    <div class="container my-4">
        <div class="row justify-content-center">
            <div class="col-12 col-xl-10">
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white border-bottom py-3">
                        <div class="row align-items-center">
                            <div class="col-12 col-md-8 mb-2 mb-md-0">
                                <h3 class="h4 mb-1 text-primary"><%= booking.bookingNo %></h3>
                                <small class="text-muted">
                                    <%= new Date(booking.bookingDate).toLocaleDateString('en-IN', { 
                                        year: 'numeric', month: 'long', day: 'numeric'
                                    }) %>
                                </small>
                            </div>
                            <div class="col-12 col-md-4 text-md-end">
                                <% if (booking.isDeleted) { %>
                                <span class="badge bg-danger px-3 py-2 me-1">
                                    Deleted
                                </span>
                                <% } %>
                                <span class="badge bg-<%= booking.status === 'Active' ? 'success' : 'danger' %> px-3 py-2 me-1">
                                    <%= booking.status %>
                                </span>
                                <% if (booking.registryCompleted) { %>
                                <span class="badge bg-dark px-3 py-2">
                                    <i class="bi bi-file-earmark-check"></i> Registry Done
                                </span>
                                <% } else { %>
                                <span class="badge bg-secondary px-3 py-2">
                                    <i class="bi bi-file-earmark-x"></i> Registry Pending
                                </span>
                                <% } %>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-4">
                        <!-- Customer Details -->
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="text-primary mb-0"><i class="bi bi-person"></i> Customer Details</h5>
                            <a href="/customer/<%= booking.customer.id %>" class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-person-circle"></i> View Full Profile
                            </a>
                        </div>
                        <div class="row g-3 mb-4">
                            <div class="col-12 col-md-6">
                                <label class="text-muted small fw-semibold text-uppercase">Customer No</label>
                                <p class="h6 mb-0"><%= booking.customer.customerNo %></p>
                            </div>
                            <div class="col-12 col-md-6">
                                <label class="text-muted small fw-semibold text-uppercase">Name</label>
                                <p class="h6 mb-0"><%= booking.customer.applicantName %></p>
                            </div>
                            <div class="col-12 col-md-6">
                                <label class="text-muted small fw-semibold text-uppercase">Father/Husband</label>
                                <p class="h6 mb-0"><%= booking.customer.fatherOrHusbandName %></p>
                            </div>
                            <div class="col-12 col-md-6">
                                <label class="text-muted small fw-semibold text-uppercase">Mobile</label>
                                <p class="h6 mb-0"><%= booking.customer.mobileNo %></p>
                            </div>
                            <div class="col-12 col-md-6">
                                <label class="text-muted small fw-semibold text-uppercase">Aadhaar</label>
                                <p class="h6 mb-0"><%= booking.customer.aadhaarNo %></p>
                            </div>
                            <% if (booking.customer.email) { %>
                            <div class="col-12 col-md-6">
                                <label class="text-muted small fw-semibold text-uppercase">Email</label>
                                <p class="h6 mb-0"><%= booking.customer.email %></p>
                            </div>
                            <% } %>
                            <div class="col-12">
                                <label class="text-muted small fw-semibold text-uppercase">Address</label>
                                <p class="h6 mb-0"><%= booking.customer.address %></p>
                            </div>
                        </div>

                        <hr>

                        <!-- Property Details -->
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="text-primary mb-0"><i class="bi bi-house"></i> Property Details</h5>
                            <a href="/project/<%= booking.project.id %>" class="btn btn-sm btn-outline-info">
                                <i class="bi bi-building"></i> View Project
                            </a>
                        </div>
                        <div class="row g-3 mb-4">
                            <div class="col-12 col-md-6">
                                <label class="text-muted small fw-semibold text-uppercase">Project</label>
                                <p class="h6 mb-0"><%= booking.project.projectName %></p>
                            </div>
                            <div class="col-12 col-md-6">
                                <label class="text-muted small fw-semibold text-uppercase">Plot No</label>
                                <p class="h5 mb-0 text-primary"><%= booking.plotNo %></p>
                            </div>
                            <div class="col-6 col-md-3">
                                <label class="text-muted small fw-semibold text-uppercase">Area</label>
                                <p class="h6 mb-0"><%= parseFloat(booking.area).toLocaleString('en-IN') %> sq.ft.</p>
                            </div>
                            <div class="col-6 col-md-3">
                                <label class="text-muted small fw-semibold text-uppercase">Rate</label>
                                <p class="h6 mb-0">₹<%= parseFloat(booking.rate).toLocaleString('en-IN') %></p>
                            </div>
                            <div class="col-6 col-md-3">
                                <label class="text-muted small fw-semibold text-uppercase">PLC</label>
                                <p class="h6 mb-0"><%= parseFloat(booking.plc).toFixed(2) %>%</p>
                            </div>
                            <div class="col-6 col-md-3">
                                <label class="text-muted small fw-semibold text-uppercase">Discount</label>
                                <p class="h6 mb-0">₹<%= parseFloat(booking.discount).toLocaleString('en-IN') %></p>
                            </div>
                            <% if (booking.legalDetails) { %>
                            <div class="col-12">
                                <label class="text-muted small fw-semibold text-uppercase">Legal Details</label>
                                <p class="h6 mb-0"><%= booking.legalDetails %></p>
                            </div>
                            <% } %>
                        </div>

                        <hr class="my-4">

                        <!-- Partner Details (Hidden for Team Leader) -->
                        <% if (userRole !== 'team_leader') { %>
                        <% if (booking.broker) { %>
                        <%
                            // Calculate commission breakdown
                            const effRate = parseFloat(booking.effectiveRate || 0);
                            const associateRateVal = parseFloat(booking.associateRate || 0);
                            const areaVal = parseFloat(booking.area || 0);
                            const baseAmountCalc = effRate * areaVal;
                            const associatePlcPercentVal = parseFloat(booking.associatePlcCommission || 0);
                            
                            const baseCommCalc = Math.max(0, (effRate - associateRateVal) * areaVal);
                            const plcCommCalc = baseAmountCalc * (associatePlcPercentVal / 100);
                        %>
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="text-success mb-0"><i class="bi bi-briefcase"></i> Partner Details</h5>
                            <a href="/broker/<%= booking.broker.id %>" class="btn btn-sm btn-success">
                                <i class="bi bi-person-badge"></i> View Partner Profile
                            </a>
                        </div>
                        
                        <div class="row g-3 mb-4">
                            <div class="col-12 col-md-6">
                                <label class="text-muted small fw-semibold text-uppercase">Partner Name</label>
                                <p class="h6 mb-0"><%= booking.broker.name %></p>
                            </div>
                            <div class="col-6 col-md-3">
                                <label class="text-muted small fw-semibold text-uppercase">Partner No</label>
                                <p class="h6 mb-0"><%= booking.broker.brokerNo %></p>
                            </div>
                            <div class="col-6 col-md-3">
                                <label class="text-muted small fw-semibold text-uppercase">Mobile</label>
                                <p class="h6 mb-0"><%= booking.broker.mobileNo %></p>
                            </div>
                            <% if (booking.associateRate && parseFloat(booking.associateRate) > 0) { %>
                            <div class="col-6 col-md-4">
                                <label class="text-muted small fw-semibold text-uppercase">Partner Rate</label>
                                <p class="h6 mb-0">₹<%= parseFloat(booking.associateRate).toLocaleString('en-IN') %></p>
                            </div>
                            <% } %>
                            <% if (booking.associatePlcCommission && parseFloat(booking.associatePlcCommission) > 0) { %>
                            <div class="col-6 col-md-4">
                                <label class="text-muted small fw-semibold text-uppercase">Partner PLC Commission</label>
                                <p class="h6 mb-0"><%= parseFloat(booking.associatePlcCommission).toFixed(2) %>%</p>
                            </div>
                            <% } %>
                        </div>

                        <!-- Commission Breakdown Card -->
                        <div class="card border-success mb-4">
                            <div class="card-header bg-success text-white">
                                <h6 class="mb-0"><i class="bi bi-cash-stack"></i> Commission Breakdown</h6>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-6 col-md-4">
                                        <small class="text-muted d-block">Base Commission</small>
                                        <h5 class="mb-0">₹<%= baseCommCalc.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></h5>
                                        <small class="text-muted">(Eff Rate - Assoc Rate) × Area</small>
                                    </div>
                                    <% if (associatePlcPercentVal > 0) { %>
                                    <div class="col-6 col-md-4">
                                        <small class="text-muted d-block">PLC Commission (<%= associatePlcPercentVal.toFixed(2) %>%)</small>
                                        <h5 class="mb-0">₹<%= plcCommCalc.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></h5>
                                        <small class="text-muted">Assoc PLC% of Base Amount</small>
                                    </div>
                                    <% } %>
                                    <div class="col-12 col-md-4">
                                        <small class="text-muted d-block fw-bold">Total Commission</small>
                                        <h3 class="mb-0 text-success">₹<%= parseFloat(booking.brokerCommission || 0).toLocaleString('en-IN') %></h3>
                                        <small class="text-muted">Base + PLC Commission</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <% } else { %>
                        <div class="alert alert-light mb-4">
                            <i class="bi bi-info-circle"></i> No partner linked to this booking
                        </div>
                        <% } %>
                        <% } %>

                        <!-- Amount Summary -->
                        <%
                            // Calculate amount breakdown
                            const effRateAmt = parseFloat(booking.effectiveRate || 0);
                            const areaAmt = parseFloat(booking.area || 0);
                            const baseAmountTotal = effRateAmt * areaAmt;
                            const plcPercentAmt = parseFloat(booking.plc || 0);
                            const plcAmountTotal = baseAmountTotal * (plcPercentAmt / 100);
                            
                            // Calculate remaining amount for the entire page
                            const bookingRemainingAmount = parseFloat(booking.totalAmount) - parseFloat(totalPaid || 0);
                        %>
                        <div class="card text-white mb-4" style="background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);">
                            <div class="card-body">
                                <h5 class="mb-3"><i class="bi bi-calculator"></i> Amount Breakdown</h5>
                                <div class="row g-3 mb-3">
                                    <div class="col-6 col-md-3">
                                        <small class="d-block opacity-75">Base Amount</small>
                                        <h5 class="mb-0">₹<%= baseAmountTotal.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></h5>
                                        <small class="opacity-75">(Effective Rate × Area)</small>
                                    </div>
                                    <% if (plcPercentAmt > 0) { %>
                                    <div class="col-6 col-md-3">
                                        <small class="d-block opacity-75">PLC Amount (<%= plcPercentAmt.toFixed(2) %>%)</small>
                                        <h5 class="mb-0">₹<%= plcAmountTotal.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></h5>
                                        <small class="opacity-75">(PLC% of Base)</small>
                                    </div>
                                    <% } %>
                                    <div class="col-12 col-md-6">
                                        <small class="d-block opacity-75 fw-bold">Total Amount</small>
                                        <h3 class="mb-0">₹<%= parseFloat(booking.totalAmount).toLocaleString('en-IN') %></h3>
                                        <small class="opacity-75">(Base + PLC)</small>
                                    </div>
                                </div>
                                <hr class="opacity-25 my-3">
                                <div class="row text-center g-3">
                                    <div class="col-12 col-md-6">
                                        <small class="d-block opacity-75">Amount Paid</small>
                                        <h3 class="mb-0" style="color: #2ecc71;">₹<%= totalPaid.toLocaleString('en-IN') %></h3>
                                    </div>
                                    <div class="col-12 col-md-6">
                                        <small class="d-block opacity-75">Balance Due</small>
                                        <h3 class="mb-0" style="color: #f39c12;">₹<%= bookingRemainingAmount.toLocaleString('en-IN') %></h3>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Additional Booking Info -->
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <div class="card border-info">
                                    <div class="card-body">
                                        <h6 class="text-muted mb-2"><i class="bi bi-bank"></i> Loan Status</h6>
                                        <h5 class="mb-0">
                                            <% if (booking.loan === 'Yes') { %>
                                                <span class="badge bg-primary">Yes</span>
                                            <% } else if (booking.loan === 'No') { %>
                                                <span class="badge bg-secondary">No</span>
                                            <% } else { %>
                                                <span class="badge bg-light text-dark">N/A</span>
                                            <% } %>
                                        </h5>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card border-warning">
                                    <div class="card-body">
                                        <h6 class="text-muted mb-2"><i class="bi bi-calendar-event"></i> Expected Registry Date</h6>
                                        <h5 class="mb-0">
                                            <% if (booking.expectedRegistryDate) { %>
                                                <%= new Date(booking.expectedRegistryDate).toLocaleDateString('en-IN', { 
                                                    year: 'numeric', month: 'short', day: 'numeric'
                                                }) %>
                                            <% } else { %>
                                                <span class="text-muted">Not Set</span>
                                            <% } %>
                                        </h5>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Registry Status -->
                        <div class="alert <%= booking.registryCompleted ? 'alert-success' : 'alert-warning' %> mb-0">
                            <div class="row align-items-center">
                                <div class="col-12 col-md-8">
                                    <h6 class="mb-1">
                                        <i class="bi bi-file-earmark-<%= booking.registryCompleted ? 'check' : 'x' %>"></i> 
                                        Registry Status
                                    </h6>
                                    <% if (booking.registryCompleted) { %>
                                        <p class="mb-0">
                                            <strong class="text-success">Registry Completed</strong>
                                            <% if (booking.registryDate) { %>
                                            <br><small>Completed on: <%= new Date(booking.registryDate).toLocaleDateString('en-IN', { 
                                                year: 'numeric', month: 'long', day: 'numeric'
                                            }) %></small>
                                            <% } %>
                                        </p>
                                    <% } else { %>
                                        <p class="mb-0 text-warning">
                                            <strong>Registry Pending</strong><br>
                                            <small>Property registration/registry is not yet completed
                                            <% if (booking.expectedRegistryDate) { %>
                                                - Expected by <%= new Date(booking.expectedRegistryDate).toLocaleDateString('en-IN', { 
                                                    year: 'numeric', month: 'short', day: 'numeric'
                                                }) %>
                                            <% } %>
                                            </small>
                                        </p>
                                    <% } %>
                                </div>
                                <div class="col-12 col-md-4 text-md-end mt-2 mt-md-0">
                                    <% if (userRole === 'admin' && !booking.isDeleted) { %>
                                        <a href="/booking/<%= booking.id %>/edit" class="btn btn-sm btn-<%= booking.registryCompleted ? 'secondary' : 'warning' %>">
                                            <i class="bi bi-pencil"></i> Update Registry
                                        </a>
                                    <% } %>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer bg-light text-muted small">
                        Created on <%= new Date(booking.createdAt).toLocaleString('en-IN') %>
                        <% if (booking.creator) { %> by <%= booking.creator.name %><% } %>
                    </div>
                </div>

                <!-- Payment History -->
                <% if (payments && payments.length > 0) { %>
                <div class="card border-0 shadow-sm mt-4">
                    <div class="card-body p-4">
                        <h5 class="text-primary mb-3"><i class="bi bi-clock-history"></i> Payment History</h5>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Receipt No</th>
                                        <th class="d-none d-md-table-cell">Date</th>
                                        <th>Amount</th>
                                        <th class="d-none d-lg-table-cell">Mode</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% payments.forEach(payment => { %>
                                        <tr>
                                            <td><strong><%= payment.receiptNo %></strong></td>
                                            <td class="d-none d-md-table-cell"><%= new Date(payment.receiptDate).toLocaleDateString('en-IN') %></td>
                                            <td class="text-success fw-bold">₹<%= parseFloat(payment.paymentAmount).toLocaleString('en-IN') %></td>
                                            <td class="d-none d-lg-table-cell"><%= payment.paymentMode %></td>
                                            <td>
                                                <a href="/payment/<%= payment.id %>" class="btn btn-sm btn-success" title="View Payment">
                                                    <i class="bi bi-receipt"></i>
                                                </a>
                                                <% if (userRole === 'admin') { %>
                                                <button type="button" class="btn btn-sm btn-outline-danger ms-1" title="Delete Payment"
                                                        onclick="if(confirm('Are you sure you want to delete this payment? The booking balance will be recalculated.')) { 
                                                            const form = document.createElement('form'); 
                                                            form.method = 'POST'; 
                                                            form.action = '/payment/<%= payment.id %>/delete'; 
                                                            document.body.appendChild(form); 
                                                            form.submit(); 
                                                        }">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                                <% } %>
                                            </td>
                                        </tr>
                                    <% }); %>
                                </tbody>
                                <tfoot class="table-light">
                                    <tr>
                                        <th class="d-none d-md-table-cell">Total Paid:</th>
                                        <th class="d-md-none">Total:</th>
                                        <th></th>
                                        <th class="text-success">₹<%= payments.reduce((sum, p) => sum + parseFloat(p.paymentAmount), 0).toLocaleString('en-IN') %></th>
                                        <th colspan="2"></th>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        
                        <% if (userRole !== 'associate' && userRole !== 'team_leader' && bookingRemainingAmount > 0) { %>
                        <div class="mt-3">
                            <a href="/payment/create?bookingId=<%= booking.id %>" class="btn btn-success">
                                <i class="bi bi-plus-circle"></i> Record New Payment
                            </a>
                        </div>
                        <% } %>
                    </div>
                </div>
                <% } else if (bookingRemainingAmount > 0) { %>
                <div class="card border-0 shadow-sm mt-4">
                    <div class="card-body p-4 text-center">
                        <i class="bi bi-receipt fs-1 text-muted"></i>
                        <p class="text-muted mt-3">No payments recorded yet</p>
                        <% if (userRole !== 'associate' && userRole !== 'team_leader') { %>
                        <a href="/payment/create?bookingId=<%= booking.id %>" class="btn btn-success">
                            <i class="bi bi-plus-circle"></i> Record First Payment
                        </a>
                        <% } %>
                    </div>
                </div>
                <% } %>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
